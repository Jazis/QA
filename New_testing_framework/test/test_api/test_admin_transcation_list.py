import allure
from playwright.sync_api import APIRequestContext
from api.function_api import validate_json_keys
from data.responses_texts import AUTH_NOT_PROVIDED, PERMISSIONS


@allure.title('Admin transaction list')
def test_admin_transaction_list(auth_token, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?date_start=2024-05-18&date_end=2024-05-19', headers=headers
    )
    assert response.status == 200
    assert response.text().__contains__('"count":62,"next":"https://dev.api.devhost.io/api/admin/transaction?date_end=2024-05-19&date_start=2024-05-18&page=2","previous":null,"results":{"total_sum":{"spend":1656.14,"pending":810.0,"refund":160.0,"reversed_amount":183.0,"settled":980.0,"fx_fee":7.17,"cross_border_fee":14.47,"decline_fee":4.5')
    assert validate_json_keys(response.text(),'{"id":5279,"account":{"id":180,"name":"ruby rose","company":{"id":171,"name":"ruby rose","owner_type":"client"},"number":"1029366"},"amount":223.0,"authorize_time":"2024-05-18T04:21:14.234143Z","batch":3091,"card":{"id":246,"name":"ruby card lifetime","number":"7574","bin":"404038","user":{"id":1037,"person":{"first_name":"5465ft","last_name":"57567thfg"}},"payment_system":"visa"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":2.73,"currency":"EUR","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":2.23,"identifier":"c9947d02-fa23-4609-a222-093de30f2ce5","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:21:14.234121Z","status":"settled","type":"spend","total":227.95999999999998,"user":{"id":301,"person":{"first_name":"ruby","last_name":"rose"}}}')== True 
    assert validate_json_keys(response.text(),'{"id":5278,"account":{"id":180,"name":"ruby rose","company":{"id":171,"name":"ruby rose","owner_type":"client"},"number":"1029366"},"amount":55.0,"authorize_time":"2024-05-18T04:20:52.643410Z","batch":3090,"card":{"id":247,"name":"rose card limit weekly","number":"3108","bin":"404038","user":{"id":301,"person":{"first_name":"ruby","last_name":"rose"}},"payment_system":"visa"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"254e319a-9a65-47d8-8ceb-39e1cb596141","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:20:52.643387Z","status":"settled","type":"spend","total":55.0,"user":{"id":301,"person":{"first_name":"ruby","last_name":"rose"}}}')== True 
    assert validate_json_keys(response.text(),'"id":5270,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":15.0,"authorize_time":"2024-05-18T04:19:19.436175Z","batch":3085,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.65,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"in","fx_fee":0.0,"identifier":"61a0dc40-5bd7-4582-a4a6-985a124c9529","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"refund","total":15.65,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5268,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":11.0,"authorize_time":"2024-05-18T04:19:08.369998Z","batch":3084,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.5,"decline_reason":"The transaction was declined for an unknown reason.","description":"","direction":"out","fx_fee":0.0,"identifier":"2e5e8fc4-03ce-4601-a2b5-4a0f6cb59078","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"declined","type":"spend","total":11.5,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5266,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":14.0,"authorize_time":"2024-05-18T04:18:53.758031Z","batch":3083,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"EUR","decline_fee":0.5,"decline_reason":"The transaction was declined for an unknown reason.","description":"","direction":"out","fx_fee":0.0,"identifier":"6ff736dc-16bc-4a5b-a827-b626ccafdc44","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"declined","type":"spend","total":14.5,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5264,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":14.0,"authorize_time":"2024-05-18T04:18:44.266534Z","batch":3082,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.5,"decline_reason":"The transaction was declined for an unknown reason.","description":"","direction":"out","fx_fee":0.0,"identifier":"64bd7f77-4841-44b7-bfb2-abc3d75a3207","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"declined","type":"spend","total":14.5,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5262,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":14.0,"authorize_time":"2024-05-18T04:18:31.636073Z","batch":3081,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.64,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"ca15b411-5fca-437a-a6aa-0d291cdc269b","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":"2024-05-18T04:18:31.636052Z","settled_time":null,"status":"reversed","type":"spend","total":14.64,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5260,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":35.0,"authorize_time":"2024-05-18T04:18:18.707035Z","batch":3080,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.85,"currency":"EUR","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.35,"identifier":"ec623c63-a67e-45a3-8ee9-22b1fa717e42","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":"2024-05-18T04:18:18.707012Z","settled_time":null,"status":"reversed","type":"spend","total":36.2,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5259,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":12.0,"authorize_time":"2024-05-18T04:18:09.392333Z","batch":3079,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"fce57b81-0c4a-4edf-88e9-c03c5634cba3","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":"2024-05-18T04:18:09.392310Z","settled_time":null,"status":"reversed","type":"spend","total":12.0,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5257,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":10.0,"authorize_time":"2024-05-18T04:17:58.648327Z","batch":3078,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.6,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"in","fx_fee":0.0,"identifier":"510663b5-217d-4c7d-bca4-7cb452f5ddde","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":"2024-05-18T04:17:58.644518Z","reversed_time":null,"settled_time":null,"status":"refund","type":"refund","total":10.6,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5255,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":22.0,"authorize_time":"2024-05-18T04:17:46.675046Z","batch":3077,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.72,"currency":"EUR","decline_fee":0.0,"decline_reason":null,"description":"","direction":"in","fx_fee":0.22,"identifier":"03da14f8-0abf-49d1-a8ff-be44247b1113","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":"2024-05-18T04:17:46.671604Z","reversed_time":null,"settled_time":null,"status":"refund","type":"refund","total":22.939999999999998,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5254,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":16.0,"authorize_time":"2024-05-18T04:17:36.928600Z","batch":3076,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"in","fx_fee":0.0,"identifier":"77c5bc7b-23e8-455c-9654-962ecf2060aa","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":"2024-05-18T04:17:36.924801Z","reversed_time":null,"settled_time":null,"status":"refund","type":"refund","total":16.0,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5252,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":22.0,"authorize_time":"2024-05-18T04:17:28.139230Z","batch":3075,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.72,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"ab7059cf-e2e7-4015-a6d0-67a1cc639781","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:17:28.139208Z","status":"settled","type":"spend","total":22.72,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5250,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":223.0,"authorize_time":"2024-05-18T04:17:15.391105Z","batch":3074,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":2.73,"currency":"EUR","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":2.23,"identifier":"db8b4e6b-5589-4609-a9c7-4726fa4c5b4d","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:17:15.391083Z","status":"settled","type":"spend","total":227.95999999999998,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5249,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":55.0,"authorize_time":"2024-05-18T04:16:59.858915Z","batch":3073,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"3e6c83ba-bb12-41a3-b76c-7c286bfdf9cf","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:16:59.858893Z","status":"settled","type":"spend","total":55.0,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 
    assert validate_json_keys(response.text(),'"id":5248,"account":{"id":177,"name":"red company","company":{"id":168,"name":"red company","owner_type":"client"},"number":"1026728"},"amount":55.0,"authorize_time":"2024-05-18T04:16:50.548388Z","batch":3072,"card":{"id":242,"name":"red_card","number":"9147","bin":"531993","user":{"id":298,"person":{"first_name":"red","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"7ba43ae4-42ba-4c0a-9b6c-2939f35522c9","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:16:50.548366Z","status":"settled","type":"spend","total":55.0,"user":{"id":298,"person":{"first_name":"red","last_name":"company"')== True 


@allure.title('Admin transaction list filter by company and status')
def test_admin_transaction_list_filter_by_company_and_status(auth_token, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?company=173&status=settled&date_start=2024-05-18&date_end=2024-05-19', headers=headers
    )

    assert response.status == 200
    assert response.text().__contains__('"count":4,"next":null,"previous":null,"results":{"total_sum":{"spend":115.0,"pending":0.0,"refund":0.0,"reversed_amount":0.0,"settled":115.0,"fx_fee":0.0,"cross_border_fee":0.0,"decline_fee":0.0')
    assert response.text().__contains__('"id":5200,"account":{"id":182,"name":"black company","company":{"id":173,"name":"black company","owner_type":"client"},"number":"1025391"},"amount":22.0,"authorize_time":"2024-05-18T04:07:14.104050Z","batch":3041,"card":{"id":254,"name":"white","number":"6326","bin":"553437","user":{"id":303,"person":{"first_name":"black","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"5713d0ac-4cd6-475e-9e99-3620f3e45502","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:07:14.104030Z","status":"settled","type":"spend","total":22.0,"user":{"id":303,"person":{"first_name":"black","last_name":"company"')
    assert response.text().__contains__('"id":5199,"account":{"id":182,"name":"black company","company":{"id":173,"name":"black company","owner_type":"client"},"number":"1025391"},"amount":23.0,"authorize_time":"2024-05-18T04:06:44.934117Z","batch":3040,"card":{"id":254,"name":"white","number":"6326","bin":"553437","user":{"id":303,"person":{"first_name":"black","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"EUR","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"7895d2fb-2a77-40d3-893b-3a0306156a39","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:06:44.934098Z","status":"settled","type":"spend","total":23.0,"user":{"id":303,"person":{"first_name":"black","last_name":"company"')
    assert response.text().__contains__('"id":5198,"account":{"id":182,"name":"black company","company":{"id":173,"name":"black company","owner_type":"client"},"number":"1025391"},"amount":15.0,"authorize_time":"2024-05-18T04:06:07.760455Z","batch":3039,"card":{"id":254,"name":"white","number":"6326","bin":"553437","user":{"id":303,"person":{"first_name":"black","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"70d7ee22-0ef5-4d1e-9ece-64e7003a05e8","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:06:07.760436Z","status":"settled","type":"spend","total":15.0,"user":{"id":303,"person":{"first_name":"black","last_name":"company"')
    assert response.text().__contains__('"id":5197,"account":{"id":182,"name":"black company","company":{"id":173,"name":"black company","owner_type":"client"},"number":"1025391"},"amount":55.0,"authorize_time":"2024-05-18T04:05:30.185505Z","batch":3038,"card":{"id":254,"name":"white","number":"6326","bin":"553437","user":{"id":303,"person":{"first_name":"black","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"a19a2974-c637-4015-90e5-c97be24abce2","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:05:30.185482Z","status":"settled","type":"spend","total":55.0,"user":{"id":303,"person":{"first_name":"black","last_name":"company"')


@allure.title('Admin transaction list filter by user and status and card')
def test_admin_transaction_list_filter_by_user_and_status_and_card(auth_token, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?status=pending&user=303&card=254&date_start=2024-05-18&date_end=2024-05-19', headers=headers
    )

    assert response.status == 200
    assert response.text().__contains__('"count":4,"next":null,"previous":null,"results":{"total_sum":{"spend":84.0,"pending":84.0,"refund":0.0,"reversed_amount":0.0,"settled":0.0,"fx_fee":0.0,"cross_border_fee":0.0,"decline_fee":0.0')
    assert response.text().__contains__('"id":5213,"account":{"id":182,"name":"black company","company":{"id":173,"name":"black company","owner_type":"client"},"number":"1025391"},"amount":15.0,"authorize_time":"2024-05-18T04:12:03.818733Z","batch":3051,"card":{"id":254,"name":"white","number":"6326","bin":"553437","user":{"id":303,"person":{"first_name":"black","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"in","fx_fee":0.0,"identifier":"b26425a7-9e81-43a7-843a-581743da83d5","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"refund","total":15.0,"user":{"id":303,"person":{"first_name":"black","last_name":"company"')
    assert response.text().__contains__('"id":5196,"account":{"id":182,"name":"black company","company":{"id":173,"name":"black company","owner_type":"client"},"number":"1025391"},"amount":46.0,"authorize_time":"2024-05-18T04:04:55.981049Z","batch":3037,"card":{"id":254,"name":"white","number":"6326","bin":"553437","user":{"id":303,"person":{"first_name":"black","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"57ebdd07-f2c5-44fe-ba5e-9ede56f8a6e3","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"spend","total":46.0,"user":{"id":303,"person":{"first_name":"black","last_name":"company"')
    assert response.text().__contains__('"id":5195,"account":{"id":182,"name":"black company","company":{"id":173,"name":"black company","owner_type":"client"},"number":"1025391"},"amount":13.0,"authorize_time":"2024-05-18T04:04:23.006678Z","batch":3036,"card":{"id":254,"name":"white","number":"6326","bin":"553437","user":{"id":303,"person":{"first_name":"black","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"EUR","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"9b158cad-6ea2-4884-aa46-8988485753a9","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"spend","total":13.0,"user":{"id":303,"person":{"first_name":"black","last_name":"company"')
    assert response.text().__contains__('"id":5194,"account":{"id":182,"name":"black company","company":{"id":173,"name":"black company","owner_type":"client"},"number":"1025391"},"amount":25.0,"authorize_time":"2024-05-18T04:03:47.881292Z","batch":3035,"card":{"id":254,"name":"white","number":"6326","bin":"553437","user":{"id":303,"person":{"first_name":"black","last_name":"company"}},"payment_system":"mc"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"c8662383-8484-4425-ba49-68ab14bec393","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"spend","total":25.0,"user":{"id":303,"person":{"first_name":"black","last_name":"company"')


@allure.title('Admin transaction list filter by type and company')
def test_admin_transaction_list_filter_by_type_and_company(auth_token, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?company=171&date_start=2024-05-18&date_end=2024-05-19&type=spend', headers=headers
    )

    assert response.status == 200
    assert response.text().__contains__('"count":2,"next":null,"previous":null,"results":{"total_sum":{"spend":282.96000000000004,"pending":0.0,"refund":0.0,"reversed_amount":0.0,"settled":278.0,"fx_fee":2.23,"cross_border_fee":2.73,"decline_fee":0.0')
    assert response.text().__contains__('"id":5279,"account":{"id":180,"name":"ruby rose","company":{"id":171,"name":"ruby rose","owner_type":"client"},"number":"1029366"},"amount":223.0,"authorize_time":"2024-05-18T04:21:14.234143Z","batch":3091,"card":{"id":246,"name":"ruby card lifetime","number":"7574","bin":"404038","user":{"id":1037,"person":{"first_name":"5465ft","last_name":"57567thfg"}},"payment_system":"visa"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":2.73,"currency":"EUR","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":2.23,"identifier":"c9947d02-fa23-4609-a222-093de30f2ce5","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:21:14.234121Z","status":"settled","type":"spend","total":227.95999999999998,"user":{"id":301,"person":{"first_name":"ruby","last_name":"rose"')
    assert response.text().__contains__('"id":5278,"account":{"id":180,"name":"ruby rose","company":{"id":171,"name":"ruby rose","owner_type":"client"},"number":"1029366"},"amount":55.0,"authorize_time":"2024-05-18T04:20:52.643410Z","batch":3090,"card":{"id":247,"name":"rose card limit weekly","number":"3108","bin":"404038","user":{"id":301,"person":{"first_name":"ruby","last_name":"rose"}},"payment_system":"visa"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"254e319a-9a65-47d8-8ceb-39e1cb596141","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":"2024-05-18T04:20:52.643387Z","status":"settled","type":"spend","total":55.0,"user":{"id":301,"person":{"first_name":"ruby","last_name":"rose"}}}]}}')


@allure.title('Admin transaction list filter by search batch')
def test_admin_transaction_list_filter_by_search_batch(auth_token, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?ordering=-authorize_time&page=1&search=3095', headers=headers
    )

    assert response.status == 200
    assert response.text().__contains__('"id":4273,"account":{"id":4,"name":"MTS","company":{"id":1,"name":"MTS","owner_type":"client"},"number":"1021481"},"amount":40.0,"authorize_time":"2024-04-26T09:23:22.928840Z","batch":2470,"card":{"id":175,"name":"zKyEFCk","number":"5856","bin":"441112","user":{"id":168,"person":{"first_name":"test","last_name":"test"}},"payment_system":"visa"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.5,"decline_reason":"The transaction was declined for an unknown reason.","description":"","direction":"out","fx_fee":0.0,"identifier":"15d23efb-a1a8-4273-950b-d810d309591f","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"declined","type":"spend","total":40.5,"user":{"id":168,"person":{"first_name":"test","last_name":"test"')
    assert response.text().__contains__('"id":2594,"account":{"id":9,"name":"ConnCompany","company":{"id":6,"name":"ConnCompany","owner_type":"client"},"number":"1015104"},"amount":14.6,"authorize_time":"2023-12-20T16:22:41.647774Z","batch":1497,"card":{"id":103,"name":"RaslCard11","number":"1064","bin":"111111","user":{"id":34,"person":{"first_name":"Conn","last_name":"User"}},"payment_system":"visa"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"082e3ae2-36fc-436e-b7b2-5574f6309530","local_amount":18.89,"mcc":"7311","merchant_info":"GOOGLE*ADS8213212388","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/google-ads-dev.png","merchant_name":"Google ADS-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"spend","total":14.6,"user":{"id":33,"person":{"first_name":"Rasul","last_name":"Cheerchiev"}}}]}}')


@allure.title('Admin transaction list filter by search batch')
def test_admin_transaction_list_filter_search_batch(auth_token, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?ordering=-authorize_time&page=1&search=3095', headers=headers
    )

    assert response.status == 200
    assert response.text().__contains__('"next":null,"previous":null,"results":{"total_sum":{"spend"')
    assert response.text().__contains__('"id":4273,"account":{"id":4,"name":"MTS","company":{"id":1,"name":"MTS","owner_type":"client"},"number":"1021481"},"amount":40.0,"authorize_time":"2024-04-26T09:23:22.928840Z","batch":2470,"card":{"id":175,"name":"zKyEFCk","number":"5856","bin":"441112","user":{"id":168,"person":{"first_name":"test","last_name":"test"}},"payment_system":"visa"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.5,"decline_reason":"The transaction was declined for an unknown reason.","description":"","direction":"out","fx_fee":0.0,"identifier":"15d23efb-a1a8-4273-950b-d810d309591f","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"declined","type":"spend","total":40.5,"user":{"id":168,"person":{"first_name":"test","last_name":"test"')
    assert response.text().__contains__('"id":2594,"account":{"id":9,"name":"ConnCompany","company":{"id":6,"name":"ConnCompany","owner_type":"client"},"number":"1015104"},"amount":14.6,"authorize_time":"2023-12-20T16:22:41.647774Z","batch":1497,"card":{"id":103,"name":"RaslCard11","number":"1064","bin":"111111","user":{"id":34,"person":{"first_name":"Conn","last_name":"User"}},"payment_system":"visa"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"082e3ae2-36fc-436e-b7b2-5574f6309530","local_amount":18.89,"mcc":"7311","merchant_info":"GOOGLE*ADS8213212388","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/google-ads-dev.png","merchant_name":"Google ADS-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"spend","total":14.6,"user":{"id":33,"person":{"first_name":"Rasul","last_name":"Cheerchiev"')


@allure.title('Admin transaction list filter by account')
def test_admin_transaction_list_filter_by_account(auth_token, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?date_start=2024-05-18&date_end=2024-05-19&account=178', headers=headers
    )

    assert response.status == 200
    # assert response.text().__contains__('{"count":2,"next":null,"previous":null,"results":{"total_sum":{"spend":170.36,"pending":168.0,"refund":0.0,"reversed_amount":0.0,"settled":0.0,"fx_fee":0.93,"cross_border_fee":1.43,"decline_fee":0.0')
    assert validate_json_keys(response.text(),'{"id":5273,"account":{"id":178,"name":"green company","company":{"id":169,"name":"green company","owner_type":"client"},"number":"1057766"},"amount":93.0,"authorize_time":"2024-05-18T04:20:03.879368Z","batch":3087,"card":{"id":239,"name":"card_3","number":"4179","bin":"404038","user":{"id":779,"person":{"first_name":"46ryty","last_name":"fyhtf"}},"payment_system":"visa"},"client_type":"spend","country":{"id":235,"name":"United Kingdom","code":"GB"},"cross_border_fee":1.43,"currency":"EUR","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.93,"identifier":"c6177358-011c-41d4-af96-fd3ef51f7b6a","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"spend","total":95.36000000000001,"user":{"id":299,"person":{"first_name":"green","last_name":"company"}}}') == True 
    assert validate_json_keys(response.text(),'{"id":5272,"account":{"id":178,"name":"green company","company":{"id":169,"name":"green company","owner_type":"client"},"number":"1057766"},"amount":75.0,"authorize_time":"2024-05-18T04:19:50.609910Z","batch":3086,"card":{"id":239,"name":"card_3","number":"4179","bin":"404038","user":{"id":779,"person":{"first_name":"46ryty","last_name":"fyhtf"}},"payment_system":"visa"},"client_type":"spend","country":{"id":236,"name":"United States","code":"US"},"cross_border_fee":0.0,"currency":"USD","decline_fee":0.0,"decline_reason":null,"description":"","direction":"out","fx_fee":0.0,"identifier":"502d9cc5-82d3-4c58-8faf-6b956b0429b1","local_amount":2.0,"mcc":"7311","merchant_info":"FACEBK ADS","merchant_image":"https://dev.api.devhost.io/media/merchant_ico/facebook-dev.png","merchant_name":"Facebook-dev","refund_time":null,"reversed_time":null,"settled_time":null,"status":"pending","type":"spend","total":75.0,"user":{"id":299,"person":{"first_name":"green","last_name":"company"}}}') == True 


@allure.title('Admin transaction list page=2')
def test_admin_transaction_list_page_2(auth_token, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?account=178&page=2', headers=headers
    )

    assert response.status == 200
    assert response.text().__contains__('"next":"https://dev.api.devhost.io/api/admin/transaction?account=178&page=3","previous":"https://dev.api.devhost.io/api/admin/transaction?account=178","results":{"total_sum":')
    assert response.text().__contains__('"pending"')
    assert response.text().__contains__('"refund"')
    assert response.text().__contains__('"reversed_amount":')
    assert response.text().__contains__('"settled":')
    assert response.text().__contains__('"fx_fee":')
    assert response.text().__contains__('"cross_border_fee":')
    assert response.text().__contains__('"decline_fee":')


@allure.title('Not admin transaction list')
def test_not_admin_transaction_list(auth_token_black_company, api_request_context: APIRequestContext) -> None:
    headers = {
        'Authorization': f"Token {auth_token_black_company}"
    }

    response = api_request_context.get(
        '/api/admin/transaction?account=178&page=2', headers=headers
    )
    assert response.status == 403
    assert response.text() == PERMISSIONS


@allure.title('Transaction list without auth')
def test_transaction_list_without_auth(api_request_context: APIRequestContext) -> None:

    response = api_request_context.get(
        '/api/admin/transaction?account=178&page=2'
    )
    assert response.status == 401
    assert response.text() == AUTH_NOT_PROVIDED
